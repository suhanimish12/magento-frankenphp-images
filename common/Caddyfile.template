# Magento 2 FrankenPHP Caddyfile Template
# ========================================
#
# This is a template file that gets processed at container startup.
# You can customize this file and mount your own version at:
#   /etc/caddy/Caddyfile.template
#
# Environment variables (with defaults):
#   - SERVER_NAME: Server hostname (default: localhost)
#   - CADDY_GLOBAL_OPTIONS: Global Caddy options
#   - FRANKENPHP_CONFIG: FrankenPHP specific configuration
#   - CADDY_EXTRA_CONFIG: Additional Caddy configuration blocks
#   - CADDY_SERVER_EXTRA_DIRECTIVES: Extra directives for the server block
#   - CADDY_TLS_CONFIG: TLS configuration (e.g., "internal" for self-signed or path to cert/key)
#   - ENABLE_HTTP3: Enable HTTP/3 support (default: true)
#   - ENABLE_EARLY_HINTS: Enable Early Hints (default: true)
#
# Documentation:
#   - Caddy: https://caddyserver.com/docs/
#   - FrankenPHP: https://frankenphp.dev/docs/
#   - Caddyfile: https://caddyserver.com/docs/caddyfile

{
    {$CADDY_GLOBAL_OPTIONS}

    # Enable HTTP/3 (QUIC) support
    servers {
        protocols h1 h2 h3
    }

    frankenphp {
        {$FRANKENPHP_CONFIG}
        # FrankenPHP worker mode for better performance (optional)
        # num_threads {$FRANKENPHP_NUM_THREADS:auto}
    }

    order php_server before file_server
}

{$CADDY_EXTRA_CONFIG}

(503) {
    rewrite * /errors/503.php
}

{$SERVER_NAME:localhost} {
    # TLS configuration with HTTP/3 support
    tls {$CADDY_TLS_CONFIG:internal} {
        protocols tls1.2 tls1.3
        curves x25519 secp256r1 secp384r1
    }
    
    log {
        format filter {
            wrap console
            fields {
                uri query {
                    replace authorization REDACTED
                }
            }
        }
    }
    log {
        output stdout
    }
    
    root * /var/www/html/pub
    
    # Advanced compression with Brotli priority
    # Brotli (br) provides ~20% better compression than gzip for text
    encode {
        # Brotli with quality 6 (good balance between compression and speed)
        br 6
        # Zstandard (modern, fast compression)
        zstd
        # Gzip as fallback
        gzip 6
        
        # Minimum length to compress (avoid overhead for small files)
        minimum_length 256
        
        # File types to compress
        match {
            header Content-Type text/*
            header Content-Type application/json*
            header Content-Type application/javascript*
            header Content-Type application/xhtml+xml*
            header Content-Type application/atom+xml*
            header Content-Type application/rss+xml*
            header Content-Type application/x-javascript*
            header Content-Type image/svg+xml*
            header Content-Type image/x-icon*
            header Content-Type application/vnd.ms-fontobject*
            header Content-Type font/*
        }
    }
    
    # Modern security and performance headers
    header {
        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "browsing-topics=(), camera=(), microphone=(), geolocation=()"
        
        # Performance headers
        X-XSS-Protection "1; mode=block"
        
        # HTTP/3 Alt-Svc header (advertise HTTP/3 support)
        Alt-Svc `h3=":443"; ma=86400`
        
        # Remove server identification
        -Server
        -X-Powered-By
    }

    {$CADDY_SERVER_EXTRA_DIRECTIVES}

    handle_errors {
        @404 {
            expression {http.error.status_code} == 404
        }
        rewrite @404 /errors/404.php
    }

    @sensitiveFiles {
        path_regexp sensitive /(\.user.ini|\.php$|\.phtml$|\.htaccess$|\.htpasswd$|\.git)
    }
    respond @sensitiveFiles 403

    header ?Permissions-Policy "browsing-topics=()"
    php_server

    handle /setup/* {
        root * /var/www/html

        @otherFiles not path /setup/pub/* /setup/index.php /setup /setup/
        handle @otherFiles {
            respond "Access Denied" 403
        }
        header /setup/pub/ {
            X-Frame-Options "SAMEORIGIN"
        }
    }

    @staticPath path_regexp reg_static ^/static/(version\d*/)?(.*)$
    handle @staticPath {
        @static file /static/{re.reg_static.2}
        rewrite @static /static/{re.reg_static.2}

        @staticFiles {
            path *.ico *.jpg *.jpeg *.png *.gif *.svg *.svgz *.webp *.avif *.avifs *.js *.css *.eot *.ttf *.otf *.woff *.woff2 *.html *.json *.webmanifest
        }
        handle @staticFiles {
            header Cache-Control "public, max-age=31536000, immutable"
            
            # Early Hints for critical resources
            @criticalCSS path *.css
            header @criticalCSS {
                Link "<{path}>; rel=preload; as=style"
                defer
            }
            
            @criticalJS path *.js
            header @criticalJS {
                Link "<{path}>; rel=preload; as=script"
                defer
            }
            
            @fonts path *.woff *.woff2 *.ttf *.otf
            header @fonts {
                Link "<{path}>; rel=preload; as=font; crossorigin"
                defer
            }
        }
        @noCacheFiles {
            path *.zip *.gz *.gzip *.bz2 *.csv *.xml
        }
        handle @noCacheFiles {
            header Cache-Control "no-store, no-cache, must-revalidate"
        }

        @dynamic not file /static/{re.reg_static.2}
        rewrite @dynamic /static.php?resource={re.reg_static.2}
        header X-Frame-Options "SAMEORIGIN"
    }

    handle /media/* {
        @denyXMLFiles path_regexp denyxml ^/media/theme_customization/.*\.xml
        respond @denyXMLFiles 403

        @staticFiles {
            path *.ico *.jpg *.jpeg *.png *.gif *.svg *.svgz *.webp *.avif *.avifs *.js *.css *.eot *.ttf *.otf *.woff *.woff2
        }
        handle @staticFiles {
            header Cache-Control "public, max-age=31536000, immutable"
            
            # Vary header for modern image formats
            @images path *.jpg *.jpeg *.png *.webp *.avif *.avifs
            header @images Vary "Accept"
        }
        @noCacheFiles {
            path *.zip *.gz *.gzip *.bz2 *.csv *.xml
        }
        handle @noCacheFiles {
            header Cache-Control "no-store, no-cache, must-revalidate"
        }

        try_files {path} {path}/ /get.php{query}
        header X-Frame-Options "SAMEORIGIN"
    }

    @blockedDirectories path /media/customer/* /media/downloadable/* /media/import/* /media/custom_options/*
    respond @blockedDirectories 403

    @blockedXMLFiles path /errors/*.xml
    respond @blockedXMLFiles 403

    @phpFiles path /index.php /get.php /static.php /errors/report.php /errors/404.php /errors/503.php /health_check.php
    handle @phpFiles {
        try_files {path} {path}/ =404
    }
}
